name: Checks

on:
  push:
    branches: [ "main", "develop" ]
    paths-ignore:
      - 'examples/**'
      - '!examples/code-agent/**'
      - '!examples/simple-examples/**'
      - '*.md'
  pull_request:
    paths-ignore:
      - 'examples/**'
      - '!examples/code-agent/**'
      - '!examples/simple-examples/**'
      - '*.md'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop' }}

env:
  JAVA_VERSION: 17
  JAVA_DISTRIBUTION: 'corretto'
  # Optimized for CI: removed -Xms to allow dynamic memory allocation
  JAVA_OPTS: "-Xmx8g -Dfile.encoding=UTF-8 -Djava.awt.headless=true"

jobs:
  compilation:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Configure Git
        run: git config --global core.autocrlf input

      - uses: actions/checkout@v5
        with:
          fetch-depth: 1  # Shallow clone for speed

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'  # Enable built-in Gradle caching

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop' }}
          gradle-home-cache-cleanup: true

      - name: Compile test classes and run lint checks
        run: ./gradlew jvmTestClasses jsTestClasses ktlintCheck --build-cache

      # Cache compiled classes for reuse in test jobs
      - name: Upload compiled test classes
        uses: actions/upload-artifact@v6
        with:
          name: compiled-classes
          path: |
            **/build/classes
            **/build/generated
          retention-days: 1
          compression-level: 6  # Faster compression

  docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Configure Git
        run: git config --global core.autocrlf input

      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: "./docs/.python-version"
          cache: 'pip'  # Cache pip dependencies

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.8.15"
          enable-cache: true

      - name: Build docs
        working-directory: ./docs
        run: |
          uv sync --frozen --all-extras
          uv run mkdocs build

  tests:
    needs: compilation  # Wait for compilation to complete
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      checks: write  # For test reporting

    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]

    steps:
      - name: Configure Git
        run: git config --global core.autocrlf input

      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop' }}
          gradle-home-cache-cleanup: true

      # Download pre-compiled classes on Ubuntu to avoid recompilation
      - name: Download compiled classes
        if: matrix.os == 'ubuntu-latest'
        uses: actions/download-artifact@v6
        with:
          name: compiled-classes

      - name: JvmTest with Gradle Wrapper and Kover coverage (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          ./gradlew jvmTest :koverBinaryReport --continue --build-cache

      - name: Check Split Packages (Ubuntu)
        if: matrix.os == 'ubuntu-latest' && github.event.pull_request.draft == false
        run: |
          ./gradlew jvmJar checkSplitPackages --build-cache

      - name: JvmTest with Gradle Wrapper (Windows/Mac)
        if: matrix.os != 'ubuntu-latest'
        run: ./gradlew jvmTest --continue --build-cache

      - name: iosSimulatorArm64Test with Gradle Wrapper (Mac)
        if: matrix.os == 'macos-latest' && github.event.pull_request.draft == false && github.repository == 'jetbrains/koog'
        run: ./gradlew linkIosSimulatorArm64 iosSimulatorArm64Test --continue --build-cache

      - name: Archive test artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-artifacts-${{ matrix.os }}
          path: |
            **/build/reports/
            **/test-results/
            .qodana/code-coverage/
          if-no-files-found: ignore
          retention-days: 5
          compression-level: 6

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v6
        if: always()
        with:
          report_paths: '**/test-results/**/TEST-*.xml'
          detailed_summary: true
          flaky_summary: true
          include_empty_in_summary: false
          include_time_in_summary: true
          annotate_only: true

  knit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - uses: actions/setup-java@v5
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop' }}
          gradle-home-cache-cleanup: true

      - name: Generate and verify code examples
        run: |
          echo "Starting knit generation..."
          FILES_BEFORE_KNIT=$(find docs/src/ -name "*.kt" 2>/dev/null | wc -l || echo "0")
          echo "Files before knit: $FILES_BEFORE_KNIT"

          ./gradlew :docs:knit --build-cache

          FILES_AFTER_KNIT=$(find docs/src/ -name "*.kt" 2>/dev/null | wc -l || echo "0")
          echo "Files after knit: $FILES_AFTER_KNIT"

          KNIT_GENERATED_FILES=$((FILES_AFTER_KNIT - FILES_BEFORE_KNIT))
          echo "Knit generated $KNIT_GENERATED_FILES files"

          echo "Starting assemble..."
          ./gradlew :docs:assemble 

  dokka:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v5
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Verify Dokka
        run: ./gradlew dokkaGenerate
